<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title> Executive Store Adopter For BU</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Sarabun:wght@400;600;700&display=swap');
    body{ font-family:'Sarabun',sans-serif; }

    /* Sidebar */
    .sidebar{ width:280px; transition:width .25s ease; }
    .sidebar.closed{ width:0 !important; border-right:0 !important; overflow:hidden; }
    @media (max-width:1024px){
      .sidebar{ position:fixed; left:0; top:0; bottom:0; z-index:40; transform:translateX(-100%); width:280px; transition:transform .25s ease; }
      .sidebar.open{ transform:translateX(0); }
      .overlay{ position:fixed; inset:0; background:rgba(0,0,0,.4); z-index:30; display:none;}
      .overlay.show{ display:block;}
    }

    .icon-btn{ display:inline-flex; align-items:center; justify-content:center; width:28px; height:28px; border-radius:.5rem; border:1px solid rgba(15,23,42,.12); background:#fff; }
    .icon-btn:hover{ background:#f8fafc; }

    /* highlight row tone */
    .row-yellow{ background:#FFFBD1; }
    .row-red{ background:#FFE5E9; }

    /* Pills */
    .pill{ display:inline-flex; align-items:center; gap:.25rem; padding:.125rem .5rem; border-radius:999px; font-weight:600; font-size:12px; }
    .pill-green{ background:#10b981; color:#fff; }
    .pill-yellow{ background:#FFFF00; color:#000; }
    .pill-red{ background:#e11d48; color:#fff; }

    /* Attach 3-up */
    .row-att{ margin-top:.25rem; }
    .row-att .grid3{ display:grid; grid-template-columns:repeat(3,1fr); gap:.25rem; }
    .row-att img{ width:100%; height:56px; object-fit:cover; border-radius:.375rem; border:1px solid rgba(15,23,42,.1); }
    .row-att .nav{ display:flex; align-items:center; gap:.25rem; margin-top:.25rem; }
    .row-att .page{ font-size:11px; color:#475569; }

    /* Modal */
    .modal{ position:fixed; inset:0; z-index:50; display:none; pointer-events:none; }
    .modal.show{ display:block; pointer-events:auto; }
    .modal .backdrop{ position:absolute; inset:0; background:rgba(2,6,23,.45); backdrop-filter:blur(2px); }
    .modal .panel{ position:absolute; inset:0; display:flex; align-items:center; justify-content:center; padding:16px; }
    .modal .card{ width:100%; max-width:1000px; background:#fff; border-radius:1rem; box-shadow:0 20px 48px rgba(2,6,23,.25); display:flex; flex-direction:column; max-height:90vh; overflow:hidden; }
    .modal .head{ padding:.875rem 1rem; border-bottom:1px solid #e2e8f0; display:flex; align-items:start; justify-content:space-between; gap:1rem; position:sticky; top:0; background:#fff; z-index:1; }
    .modal .body{ padding:1rem; overflow-y:auto; }
    .modal .foot{ padding:1rem; border-top:1px solid #e2e8f0; position:sticky; bottom:0; background:#fff; z-index:1; }

    .meta-row{ display:grid; grid-template-columns:1fr; gap:.25rem; }
    @media (min-width:768px){ .meta-row{ grid-template-columns:repeat(3,1fr); } }
    .meta-item{ font-size:13px; color:#334155; }
    .meta-item .label{ color:#64748b; margin-right:.25rem; }
    .meta-item .text{ display:-webkit-box; -webkit-line-clamp:2; -webkit-box-orient:vertical; overflow:hidden; }

    .logo-wide { aspect-ratio: 1355 / 392; height: 48px; width: auto; object-fit: contain; }
  </style>
</head>
<body class="bg-gradient-to-br from-emerald-50 via-teal-50 to-sky-50 min-h-screen">

<!-- =================== LOGIN (‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠ BU) =================== -->
<section id="loginPage" class="min-h-screen flex items-center justify-center p-6">
  <div class="max-w-3xl w-full">
    <div class="rounded-3xl border bg-white/90 backdrop-blur p-8 shadow-2xl">
      <div class="flex items-center gap-4 mb-6">
        <img src="ESAPlogo.png" class="logo-wide rounded-md shadow" alt="logo">
        <div>
          <h1 class="text-3xl md:text-4xl font-extrabold tracking-tight text-slate-900">Executive Store Adopter-BU</h1>
          <p class="text-slate-600 -mt-0.5">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö (‡πÉ‡∏™‡πà‡∏ä‡∏∑‡πà‡∏≠ BU)</p>
        </div>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-12 gap-3 items-end">
        <div class="md:col-span-8">
         <label class="block text-sm font-medium mb-1">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô‡∏Ç‡∏≠‡∏á‡∏ó‡πà‡∏≤‡∏ô</label>
<select id="code" class="w-full border rounded-2xl px-3 py-2.5 shadow-sm focus:outline-none focus:ring-2 focus:ring-emerald-300">
  <option value="" disabled selected>‚Äî ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å BU ‚Äî</option>
  <option>Commercial</option>
  <option>HR</option>
  <option>Supply Chain</option>
  <option>Maintenance</option>
  <option>Town Center</option>
  <option>Property</option>
  <option>Wawee</option>
  <option>Pure</option>
  <option>Marketing</option>
  <option>Operation</option>
</select>
 
        </div>
        <div class="md:col-span-4">
          <button id="btnLogin" class="w-full rounded-2xl bg-emerald-600 text-white px-4 py-3 font-bold shadow hover:bg-emerald-700 active:scale-[.99] transition">
            ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö
          </button>
        </div>
      </div>

      <p id="loginInfo" class="text-sm text-slate-600 mt-3"></p>
    </div>
  </div>
</section>

<!-- =================== APP =================== -->
<section id="appShell" class="hidden">
  <div id="sbOverlay" class="overlay"></div>
  <div class="flex">
    <!-- Sidebar -->
    <aside id="sidebar" class="sidebar bg-white/90 border-r backdrop-blur lg:translate-x-0">
      <div class="p-4 border-b">
        <div class="font-bold text-slate-900">BU Portal</div>
        <div id="whoami" class="text-xs text-slate-600">‚Äî</div>
      </div>
      <nav class="p-2">
        <div class="px-3 py-2 text-xs text-slate-500">‡πÄ‡∏°‡∏ô‡∏π</div>
        <button data-tab="tabStore" class="nav-btn w-full flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-slate-100 font-medium bg-slate-100">
          <svg class="w-5 h-5 text-emerald-600" viewBox="0 0 24 24" fill="none"><path d="M3 12h8V3H3v9Zm10 9h8V12h-8v9ZM3 21h8v-7H3v7Zm10-18v7h8V3h-8Z" stroke="currentColor" stroke-width="1.5"/></svg>
         Executive Store Adopter For BU 
        </button>
        <button id="btnLogout" class="w-full mt-2 flex items-center gap-3 px-3 py-2 rounded-lg bg-rose-50 text-rose-700 hover:bg-rose-100 font-medium">
          <svg class="w-5 h-5" viewBox="0 0 24 24" fill="none"><path d="M16 17l5-5-5-5M21 12H9M13 7V5a2 2 0 00-2-2H5a2 2 0 00-2 2v14a2 2 0 002 2h6a2 2 0 002-2v-2" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/></svg>
          ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö
        </button>
      </nav>
    </aside>

    <!-- MAIN -->
    <main class="flex-1 min-h-screen">
      <!-- Top bar -->
      <div class="flex items-center justify-between p-3 bg-white/80 backdrop-blur sticky top-0 z-30 border-b">
        <div class="flex items-center gap-2">
          <button id="btnHamburger" class="p-2 rounded-lg border text-slate-700 hover:bg-slate-50" title="‡πÄ‡∏°‡∏ô‡∏π">
            <svg class="w-5 h-5" viewBox="0 0 24 24" fill="none"><path d="M4 6h16M4 12h16M4 18h16" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/></svg>
          </button>
          <div class="font-semibold text-slate-900">Executive Store Adopter For BU</div>
        </div>
        <div class="text-xs text-slate-500" id="resInfoTop">‚Äî</div>
      </div>

      <!-- ======= DASHBOARD STATUS (BU) ======= -->
<div id="buStatusTiles" class="px-3 pt-3 pb-2 bg-white/80 backdrop-blur border-b">
  <div class="grid grid-cols-2 md:grid-cols-4 gap-2">
    <div id="tileDone"   class="rounded-2xl p-4 shadow text-white bg-gradient-to-br from-emerald-600 to-emerald-500"></div>
    <div id="tileInProg" class="rounded-2xl p-4 shadow text-white bg-gradient-to-br from-sky-600 to-sky-500"></div>
    <div id="tileSent"   class="rounded-2xl p-4 shadow text-slate-900 bg-gradient-to-br from-amber-400 to-amber-300"></div>
    <div id="tileNone"   class="rounded-2xl p-4 shadow text-white bg-gradient-to-br from-rose-600 to-rose-500"></div>
  </div>
</div>


      <!-- Filters (‡πÅ‡∏ö‡∏ö Site-Store) -->
      <div class="sticky top-[56px] z-20 bg-white/70 backdrop-blur border-b">
        <div class="px-3 py-2">
        <div class="p-2 rounded-xl border bg-white/80">
  <div class="text-[11px] font-semibold text-slate-600 mb-1">Filters</div>
  <div class="flex flex-nowrap items-end gap-2 overflow-x-auto py-1">

    <label class="block min-w-[140px]">
      <span class="block text-[11px] text-slate-500 mb-0.5">Round</span>
      <select id="f_round" class="w-full border rounded p-2 text-sm"></select>
    </label>

    <label class="block min-w-[140px]">
      <span class="block text-[11px] text-slate-500 mb-0.5">VP</span>
      <select id="f_vp" class="w-full border rounded p-2 text-sm"></select>
    </label>

    <label class="block min-w-[180px]">
      <span class="block text-[11px] text-slate-500 mb-0.5">Area</span>
      <select id="f_area" class="w-full border rounded p-2 text-sm"></select>
    </label>

    <label class="block min-w-[200px]">
      <span class="block text-[11px] text-slate-500 mb-0.5">Topic</span>
      <select id="f_topic" class="w-full border rounded p-2 text-sm"></select>
    </label>

    <label class="block min-w-[160px]">
      <span class="block text-[11px] text-slate-500 mb-0.5">Format</span>
      <select id="f_format" class="w-full border rounded p-2 text-sm"></select>
    </label>

<label class="block min-w-[160px]">
  <span class="block text-[11px] text-slate-500 mb-0.5">Status</span>
  <select id="f_status" class="w-full border rounded p-2 text-sm">
    <option value="">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
    <option>Sent BU</option>
    <option>In progress</option>
    <option>Done</option>
  </select>
</label>

    <label class="block min-w-[200px]">
      <span class="block text-[11px] text-slate-500 mb-0.5">Store</span>
      <input id="f_store" class="w-full border rounded p-2 text-sm" placeholder="‡∏£‡∏´‡∏±‡∏™‡∏´‡∏£‡∏∑‡∏≠‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏≤‡∏Ç‡∏≤" />
    </label>

    <div class="flex items-end gap-2 ml-auto pr-1">
      <button id="btnSearch" class="px-3 py-2 rounded border bg-sky-600 text-white text-sm">‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤</button>
      <button id="btnReset" class="px-3 py-2 rounded border bg-white text-sm">‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï</button>
    </div>
  </div>
</div>  

      <!-- AREA -> TOPIC -> QUESTION (Round1/2/3) -->
      <div class="p-4 space-y-6" id="areaContainers"></div>
      <div class="px-4 pb-6 text-xs text-slate-500 flex items-center justify-between">
        <div id="resInfo">‚Äî</div>
        <div class="flex items-center gap-2">
          <button id="prev" class="px-3 py-1.5 rounded border bg-white hover:bg-slate-50">Prev</button>
          <button id="next" class="px-3 py-1.5 rounded border bg-white hover:bg-slate-50">Next</button>
          <span id="pgInfo" class="text-xs text-slate-500"></span>
        </div>
      </div>
    </main>
  </div>
</section>

<!-- Loader -->
<div id="loader" class="fixed inset-0 bg-white/60 backdrop-blur-sm hidden z-50">
  <div class="absolute inset-0 flex items-center justify-center">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</div>
</div>

<!-- =================== MODAL: Read-only Comment/Reason + Editable Action/Status/Due =================== -->
<div id="actionModal" class="modal" aria-hidden="true">
  <div class="backdrop"></div>
  <div class="panel">
    <div class="card">
      <div class="head">
        <div class="space-y-2">
          <div class="text-xs text-slate-500">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î (‡∏£‡∏≠‡∏ö‡∏ó‡∏µ‡πà <span id="am_round">-</span>)</div>
          <div class="meta-row">
            <div class="meta-item"><span class="label">Area:</span><span id="am_meta_area" class="text"></span></div>
            <div class="meta-item"><span class="label">Topic:</span><span id="am_meta_topic" class="text"></span></div>
            <div class="meta-item"><span class="label">Question:</span><span id="am_meta_question" class="text"></span></div>
          </div>
        </div>
        <button class="icon-btn" id="am_close" title="‡∏õ‡∏¥‡∏î">
          <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none"><path d="M6 6l12 12M18 6L6 18" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/></svg>
        </button>
      </div>
      <div class="body space-y-5">
        <section>
          <div class="text-xs text-slate-500 mb-1">Comment From Adopter</div>
          <div id="am_comment_ro" class="whitespace-pre-wrap rounded-lg border bg-slate-50 p-3 leading-relaxed text-[15px] text-slate-700 min-h-[56px]">‚Äî</div>
        </section>
        <section>
          <div class="text-xs text-slate-500 mb-1">Reason From Operation</div>
          <div id="am_reason_ro" class="whitespace-pre-wrap rounded-lg border bg-slate-50 p-3 text-[14px] text-slate-700 min-h-[44px]">‚Äî</div>
        </section>
        <section>
          <div class="text-xs text-slate-500 mb-2">Action </div>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <label class="block md:col-span-2">
              <span class="text-xs text-slate-500">Action</span>
              <textarea id="am_action" class="mt-1 w-full border rounded-lg p-2 min-h-[120px]" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡πÅ‡∏ú‡∏ô‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏Ç‡∏≠‡∏á BU"></textarea>
            </label>
            <label class="block">
              <span class="text-xs text-slate-500">Status</span>
              <select id="am_status" class="mt-1 w-full border rounded-lg p-2">
                <option>Sent BU</option>
                <option>In progress</option>
                <option>Done</option>
              </select>
            </label>
            <label class="block">
              <span class="text-xs text-slate-500">Due</span>
              <input id="am_due" type="date" class="mt-1 w-full border rounded-lg p-2">
            </label>
          </div>
        </section>
      </div>
      <div class="foot flex items-center justify-between">
        <div class="text-xs text-slate-500">*Reason from Operation to request to BU </div>
        <div class="flex items-center gap-2">
          <button id="am_save" class="px-4 py-2 rounded-lg bg-emerald-600 text-white">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
          <button id="am_cancel" class="px-4 py-2 rounded-lg border bg-white">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
/***************** Supabase Config *****************/
const SUPABASE_URL = 'https://iodmkpvgrvlpiydurimv.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImlvZG1rcHZncnZscGl5ZHVyaW12Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc5MTE5MDksImV4cCI6MjA3MzQ4NzkwOX0.8lGDPEnViaLBY0mDf2IfsfwGI8qBFO7G01tC_BnR3cs';

let SB = null;
let CURRENT_BU = '';
let ALL_ITEMS = [];
let TOTAL = 0, LIMIT = 600, PAGE = 1;
let AM_CTX = null; // ‡∏ö‡∏£‡∏¥‡∏ö‡∏ó modal

const qs = id => document.getElementById(id);
const show = (el,on)=> el.classList[on?'remove':'add']('hidden');
const loading = (on)=> show(qs('loader'), on);

function sbInit(){
  SB = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, { auth:{ persistSession:false } });
}

/***************** Helpers *****************/
function getActionId(obj){ return obj?.actionid ?? obj?.action_id ?? obj?.actionId ?? null; }
function normalizeImageUrl(u){
  if(!u) return '';
  try{
    const url = new URL(u);
    const host = url.hostname;

    // Google Drive
    if (host.includes('drive.google.com')){
      // ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏ó‡∏±‡πâ‡∏á /file/d/ID/ ‡πÅ‡∏•‡∏∞ id=ID
      const m = u.match(/\/file\/d\/([^/]+)\//);
      const id = m?.[1] || url.searchParams.get('id');
      if (id) return `https://drive.google.com/uc?export=view&id=${id}`;
    }

    // Dropbox
    if (host.includes('dropbox.com')){
      url.searchParams.set('raw','1');
      url.searchParams.delete('dl');
      return url.toString();
    }

    // (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏≠‡∏∑‡πà‡∏ô‡∏Å‡πá‡πÉ‡∏´‡πâ‡∏ú‡πà‡∏≤‡∏ô‡∏ï‡∏£‡∏á‡πÜ)
    return u;
  }catch(_){ return u; }
}

function mapRowToItem(r){
  // ‡∏£‡∏ß‡∏°‡∏•‡∏¥‡∏á‡∏Å‡πå‡πÅ‡∏ô‡∏ö‡∏à‡∏≤‡∏Å‡∏´‡∏•‡∏≤‡∏¢‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå
  const rawLinks = [r.attach_1, r.attach_2, r.attch_2, r.attach_3]
    .map(v => (v ?? '').trim())
    .filter(Boolean);

  const urls = Array.from(new Set(rawLinks.map(normalizeImageUrl))).filter(Boolean);
  const attachments = urls.map(u => ({ url: u }));

  return {
    refno:       r.refno,
    round:       r.round,
    area:        r.area,
    topic:       r.topic,
    question:    r.question,
    storeCode:   r.storecode ?? r.storeCode ?? '',
    storeName:   r.storename ?? r.storeName ?? '',
    region:      r.region ?? '',
    format:      r.format ?? '',
    answer:      r.answer ?? '',
    result:      r.answer ?? '',
    comment:     r.comment ?? '',
    reason:      r.reason ?? '',
    attachments,
    actionId:    r.actionid ?? r.action_id ?? r.actionId ?? null,

    // ‚úÖ ‡∏≠‡πà‡∏≤‡∏ô‡∏à‡∏≤‡∏Å‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏à‡∏£‡∏¥‡∏á‡∏Ç‡∏≠‡∏á SITESTORE
    action: {
      text:   (r.action_text ?? r.action ?? '') || '',
      status: (r.action_status ?? r.actionstatus ?? '') || '',
      dueDate:(r.due_date ?? r.duedate ?? null)
    },

    dueDate:     r.duedate ?? r.due_date ?? null,
    status:      r.actionstatus ?? r.action_status ?? null,
    bu:          r.bu ?? ''
  };
}

function normalizeAttachments(att){
  try{
    if(!att) return [];
    if (Array.isArray(att)) return att.map(x=> typeof x==='string'? x : x?.url).filter(Boolean).map(normalizeImageUrl);
    if (typeof att === 'string'){
      if (att.trim().startsWith('[')) return normalizeAttachments(JSON.parse(att));
      return att.split(',').map(s=>s.trim()).filter(Boolean).map(normalizeImageUrl);
    }
    return [];
  }catch(_){ return []; }
}
function pill(ans){
  const a = String(ans||'').toLowerCase();
  if(/green/.test(a))  return `<span class="pill pill-green">Green</span>`;
  if(/yellow/.test(a)) return `<span class="pill pill-yellow">Yellow</span>`;
  if(/red/.test(a))    return `<span class="pill pill-red">Red</span>`;
  return `<span class="text-slate-400">-</span>`;
}
function toneClass(ans){
  const a = String(ans||'').toLowerCase();
  if(/red/.test(a)) return 'row-red';
  if(/yellow/.test(a)) return 'row-yellow';
  return '';
}


/***************** Query: SITESTORE (filter bu) *****************
 * NOTE: ‡∏ñ‡πâ‡∏≤‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏Ñ‡∏∏‡∏ì‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡∏±‡∏ß‡∏û‡∏¥‡∏°‡∏û‡πå‡πÉ‡∏´‡∏ç‡πà (‡πÄ‡∏ä‡πà‡∏ô "SITESTORE") ‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏™‡πà‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏ö‡∏ö‡∏°‡∏µ‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏´‡∏°‡∏≤‡∏¢‡∏Ñ‡∏≥‡∏û‡∏π‡∏î‡∏Ñ‡∏π‡πà
 *       SB.from('"SITESTORE"')
 * ‡∏ñ‡πâ‡∏≤‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡∏±‡∏ß‡∏û‡∏¥‡∏°‡∏û‡πå‡πÄ‡∏•‡πá‡∏Å ‡πÉ‡∏ä‡πâ SB.from('sitestore') ‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢
 ****************************************************************/
async function sbSearchBuItems({ round, area, topic, limit = LIMIT, page = PAGE }){
  // ‡∏ñ‡πâ‡∏≤‡∏ä‡∏∑‡πà‡∏≠‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÉ‡∏ô DB ‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡πá‡∏Å ‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ 'sitestore'
  // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡∏±‡∏ß‡πÉ‡∏´‡∏ç‡πà create ‡πÅ‡∏ö‡∏ö‡πÑ‡∏°‡πà‡∏≠‡πâ‡∏≤‡∏á quote ‡πÑ‡∏î‡πâ (supabase-js ‡∏à‡∏∞‡∏ó‡∏≥‡∏ñ‡∏π‡∏Å‡πÄ‡∏≠‡∏á)
  let q = SB.from('SITESTORE')

  .select(
    `refno,round,area,topic,question,storecode,storename,region,format,answer,comment,reason,
     attach_1,attach_2,attach_3,
     action,actionid,actionstatus,duedate,bu`,
    { count: 'exact' }
  )
  .eq('bu', CURRENT_BU);


  if (round) q = q.eq('round', round);
  if (area)  q = q.ilike('area', `%${area}%`);
  if (topic) q = q.ilike('topic', `%${topic}%`);

  
  const from = (page - 1) * limit;
  const to   = from + limit - 1;

  const { data, count, error } = await q
    .order('area',       { ascending: true })
    .order('topic',      { ascending: true })
    .order('storecode', { ascending: true })
    .order('round',      { ascending: true })
    .range(from, to);

  if (error) throw error;

  return {
    total: count ?? 0,
    items: (data || []).map(mapRowToItem),
  };
}
/***************** Save: Action/Status/Due *****************
 * ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡∏á‡∏ï‡∏≤‡∏£‡∏≤‡∏á actions (‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô SITESTORE flow ‡πÄ‡∏î‡∏¥‡∏°)
 * ‡∏ñ‡πâ‡∏≤‡∏£‡∏∞‡∏ö‡∏ö‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡πÄ‡∏Å‡πá‡∏ö action ‡πÑ‡∏ß‡πâ‡πÉ‡∏ô‡∏ï‡∏≤‡∏£‡∏≤‡∏á SITESTORE ‡πÄ‡∏≠‡∏á ‡πÉ‡∏´‡πâ‡πÅ‡∏Å‡πâ‡∏à‡∏≤‡∏Å SB.from('actions')
 * ‡πÄ‡∏õ‡πá‡∏ô SB.from('"SITESTORE"') ‡πÅ‡∏•‡∏∞‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô .update/insert ‡πÉ‡∏´‡πâ‡∏ï‡∏£‡∏á‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì
 ***********************************************************/
// ‚úÖ ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô Action ‡∏•‡∏á‡∏ï‡∏≤‡∏£‡∏≤‡∏á SITESTORE ‡πÇ‡∏î‡∏¢‡∏ï‡∏£‡∏á
async function sbSaveAction(payload){
  const { refno, action, actionId, context } = payload;
  const patch = {
    action:        action?.text ?? null,
    actionstatus:  action?.status ?? null,
    duedate:       action?.dueDate ?? null,
    bu:            CURRENT_BU   // ‡∏Å‡∏±‡∏ô‡∏Å‡∏£‡∏ì‡∏µ‡πÅ‡∏ñ‡∏ß‡πÄ‡∏î‡∏¥‡∏°‡∏¢‡∏±‡∏á‡∏ß‡πà‡∏≤‡∏á
  };

  // 1) ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ actionId ‡πÉ‡∏´‡πâ‡πÄ‡∏à‡∏≤‡∏∞‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏î‡πâ‡∏ß‡∏¢ actionid
  if (actionId) {
    const { data, error } = await SB
      .from('SITESTORE')
      .update(patch)
      .eq('actionid', actionId)
      .select('id');   // ‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡πÉ‡∏´‡πâ‡∏Ñ‡∏∑‡∏ô‡πÅ‡∏ñ‡∏ß
    if (error) throw error;
    if (!data?.length) throw new Error('‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÅ‡∏ñ‡∏ß‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö actionId ‡∏ô‡∏µ‡πâ');
    return true;
  }

  // 2) ‡πÑ‡∏°‡πà‡∏°‡∏µ actionId -> match ‡πÅ‡∏ö‡∏ö‡∏£‡∏∞‡∏ö‡∏∏‡∏ö‡∏£‡∏¥‡∏ö‡∏ó‡πÉ‡∏´‡πâ‡πÅ‡∏Ñ‡∏ö‡∏û‡∏≠
  let q = SB.from('SITESTORE')
    .update(patch)
    .eq('refno', refno)
    .eq('bu', CURRENT_BU)
    .eq('topic', context?.topic || '')
    .eq('question', context?.question || '');

  if (context?.storeCode) q = q.eq('storecode', context.storeCode);
  if (context?.round)     q = q.eq('round', context.round);

  const { data, error } = await q.select('id');  // ‡πÉ‡∏´‡πâ‡∏Ñ‡∏∑‡∏ô‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï
  if (error) throw error;
  if (!data?.length) throw new Error('‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÅ‡∏ñ‡∏ß‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï (‡∏•‡∏≠‡∏á‡∏£‡∏∞‡∏ö‡∏∏ store/round ‡πÉ‡∏´‡πâ‡∏ä‡∏±‡∏î)');
  return true;
}



/***************** Login *****************/
qs('btnLogin').onclick = async ()=>{
  const code = (qs('code').value||'').trim();
  if(!code) return alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å BU');
  try{
    loading(true);
    sbInit();
    CURRENT_BU = code;

    show(qs('loginPage'), false); show(qs('appShell'), true);
    qs('whoami').textContent = `BU (${CURRENT_BU})`;

    PAGE = 1;
    await search();
  }catch(ex){ alert(ex.message||ex); }
  finally{ loading(false); }
};
qs('code').addEventListener('keydown', e => {
  if (e.key === 'Enter' || e.key === ' ') qs('btnLogin').click();
});

qs('btnLogout').onclick = ()=> location.reload();

/***************** Filters & Paging *****************/
qs('btnSearch').onclick = async ()=>{ PAGE=1; await search(); };
qs('btnReset').onclick = async ()=>{
  qs('f_round').value=''; qs('f_area').value=''; qs('f_topic').value='';
  qs('f_format').value=''; 
  qs('f_status').value=''; qs('f_store').value='';
  PAGE=1; await search();
};

qs('prev').onclick = async ()=>{ if(PAGE>1){ PAGE--; await search(); } };
qs('next').onclick = async ()=>{
  const maxPg = Math.max(1, Math.ceil(TOTAL/LIMIT));
  if(PAGE<maxPg){ PAGE++; await search(); }
};

/* ===== Helpers for status ===== */
function normalizeStatus(s){
  const v = String(s||'').trim().toLowerCase();
  if(!v) return 'none';
  if(v==='done') return 'done';
  if(v==='in progress' || v==='inprogress') return 'inprogress';
  if(v==='sent bu' || v==='sent to bu' || v==='sent') return 'sent';
  return 'none';
}

/* ===== Render Dashboard tiles (BU) ===== */
function renderStatusTilesBU(){
  // ‡∏ô‡∏±‡∏ö‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏Ç‡πâ‡∏≠‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡πá‡∏ô Yellow/Red (‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏ó‡∏≥ Action)
  const YR = ALL_ITEMS.filter(it => /yellow|red/i.test(String(it.answer||it.result||'')));

  const stats = { done:0, inprogress:0, sent:0, none:0 };
  YR.forEach(it=>{
    const k = normalizeStatus(it.action?.status || it.status);
    if(k in stats) stats[k]++; else stats.none++;
  });

  const tiles = [
    { id:'tileDone',   title:'DONE',        value:stats.done,       note:'Action ‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô' },
    { id:'tileInProg', title:'IN PROGRESS', value:stats.inprogress, note:'‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£' },
    { id:'tileSent',   title:'SENT BU',     value:stats.sent,       note:'‡∏£‡∏≠ BU ‡∏£‡∏±‡∏ö‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á/‡πÄ‡∏£‡∏¥‡πà‡∏°' },
    { id:'tileNone',   title:'NO ACTION',   value:stats.none,       note:'‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÅ‡∏ú‡∏ô' },
  ];

  tiles.forEach(t=>{
    const el = document.getElementById(t.id);
    if(!el) return;
    el.innerHTML = `
      <div class="flex items-center justify-between">
        <div class="text-[13px] opacity-90 font-semibold tracking-wide">${t.title}</div>
        <div class="w-9 h-9 rounded-xl bg-white/20 flex items-center justify-center text-lg">${t.title==='DONE'?'‚úî':'üïí'}</div>
      </div>
      <div class="text-3xl font-extrabold mt-1">${t.value}</div>
      <div class="text-[11px] mt-1 opacity-90">${t.note}</div>
    `;
  });
}

/***************** Search + Render (Pivot ‡πÅ‡∏ö‡∏ö Site-Store) *****************/
async function search(){
  loading(true);
  try{
    const params = {
      round: qs('f_round').value.trim(),
      area:  qs('f_area').value.trim(),
      topic: qs('f_topic').value.trim(),
      limit: LIMIT,
      page:  PAGE
    };
    const { total, items } = await sbSearchBuItems(params);
    TOTAL = total; ALL_ITEMS = items;
    bindAreaTopicOptions();
    renderAreaContainers();
    renderStatusTilesBU();
    qs('resInfo').textContent = `‡∏û‡∏ö ${TOTAL} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ (‡∏´‡∏ô‡πâ‡∏≤‡∏ô‡∏µ‡πâ ${ALL_ITEMS.length})`;
    qs('resInfoTop').textContent = `‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ${TOTAL} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`;
    qs('pgInfo').textContent = `‡∏´‡∏ô‡πâ‡∏≤ ${PAGE} / ${Math.max(1, Math.ceil(TOTAL/LIMIT))}`;
  }catch(ex){ alert(ex.message||ex); }
  finally{ loading(false); }
}

function anyYellowRed(roundAns){
  const v = [roundAns[1], roundAns[2], roundAns[3]].map(x=>String(x||'').toLowerCase());
  if(v.some(a=>/red/.test(a))) return 'red';
  if(v.some(a=>/yellow/.test(a))) return 'yellow';
  return '';
}

function pivotByQuestionAcrossRounds(items){
  const map = new Map();
  for (const it of items){
    const area = it.area||''; const topic = it.topic||''; const question = it.question||'';
    const storeCode = it.storeCode||''; const storeName = it.storeName||'';
    const round = Number(it.round||0);
    const key = `${area}||${topic}||${question}||${storeCode}`;
    if(!map.has(key)){
      map.set(key, { key, area, topic, question, storeCode, storeName, roundAns:{1:null,2:null,3:null}, roundRaw:{1:null,2:null,3:null}, action:null, actionId: getActionId(it), refno: it.refno||'' });
    }
    const row = map.get(key);
    if ([1,2,3].includes(round)){
      row.roundAns[round] = it.answer||null;
      row.roundRaw[round] = it;
    }
    // ‡πÉ‡∏ä‡πâ action ‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏à‡∏≤‡∏Å‡∏£‡∏≠‡∏ö‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î‡∏ó‡∏µ‡πà‡∏°‡∏µ
    row.action = (row.roundRaw[3]?.action || row.roundRaw[2]?.action || row.roundRaw[1]?.action || row.action || null);
    row.actionId = getActionId(row.roundRaw[3]) || getActionId(row.roundRaw[2]) || getActionId(row.roundRaw[1]) || row.actionId;
  }
  return Array.from(map.values());
}

const norm = s => String(s||'').trim().toLowerCase();
function uniqueSorted(list){
  const s = new Set();
  list.forEach(v => { const t = String(v??'').trim(); if(t) s.add(t); });
  return Array.from(s).sort((a,b)=> a.localeCompare(b,'th'));
}
function fillSelect(sel, values, placeholder='‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î'){
  sel.innerHTML = `<option value="">${placeholder}</option>` +
                  values.map(v=>`<option>${v}</option>`).join('');
}


function bindAreaTopicOptions(){
  const selRound  = qs('f_round');
  const selVP     = qs('f_vp');
  const selArea   = qs('f_area');
  const selTopic  = qs('f_topic');
  const selFormat = qs('f_format');
  const selStatus = qs('f_status');  

  // ‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏à‡∏≤‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
  const rounds  = uniqueSorted(ALL_ITEMS.map(x=>x.round).filter(Boolean));
  const vps     = uniqueSorted(ALL_ITEMS.map(x=>x.region));
  const areas   = uniqueSorted(ALL_ITEMS.map(x=>x.area));
  const topics  = uniqueSorted(ALL_ITEMS.map(x=>x.topic));
  const formats = uniqueSorted(ALL_ITEMS.map(x=>x.format));

  fillSelect(selRound,  rounds,  '‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î');
  fillSelect(selVP,     vps,     '‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î');
  fillSelect(selArea,   areas,   '‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î');
  fillSelect(selTopic,  topics,  '‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î');
  fillSelect(selFormat, formats, '‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î');
// ‡πÄ‡∏ï‡∏¥‡∏°‡∏Ñ‡πà‡∏≤ Status ‡πÄ‡∏õ‡πá‡∏ô‡∏ä‡∏∏‡∏î‡∏°‡∏≤‡∏ï‡∏£‡∏ê‡∏≤‡∏ô
if (selStatus) {
  selStatus.innerHTML = `
    <option value="">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
    <option>Sent BU</option>
    <option>In progress</option>
    <option>Done</option>
  `;
}

  // ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÉ‡∏î‡∏Å‡πá‡∏ï‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏Ñ‡πà‡∏≤ -> ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏≠‡∏∑‡πà‡∏ô‡πÉ‡∏´‡πâ‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏Ñ‡πà‡∏≤‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡πá‡∏ô‡πÑ‡∏õ‡πÑ‡∏î‡πâ
  const refreshDependentOptions = ()=>{
   const rV = norm(selRound.value);
const vV = norm(selVP.value);
const aV = norm(selArea.value);
const tV = norm(selTopic.value);
const fV = norm(selFormat.value);
const sV = norm(selStatus?.value); // ‚¨ÖÔ∏è ‡πÄ‡∏û‡∏¥‡πà‡∏°


   const base = ALL_ITEMS.filter(x=>{
  const okR = !rV || String(x.round) === selRound.value;
  const okV = !vV || norm(x.region) === vV;
  const okA = !aV || norm(x.area)   === aV;
  const okT = !tV || norm(x.topic)  === tV;
  const okF = !fV || norm(x.format) === fV;
  const okS = !sV || norm(x.status || x.action?.status) === sV; 
  return okR && okV && okA && okT && okF && okS;
});


    const keep = (sel, vals, ph) => {
      const prev = sel.value;
      fillSelect(sel, uniqueSorted(vals), ph);
      if ([...sel.options].some(o => norm(o.value) === norm(prev))) sel.value = prev;
    };

    keep(selRound,  base.map(x=>x.round),  '‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î');
    keep(selVP,     base.map(x=>x.region), '‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î');
    keep(selArea,   base.map(x=>x.area),   '‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î');
    keep(selTopic,  base.map(x=>x.topic),  '‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î');
    keep(selFormat, base.map(x=>x.format), '‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î');
  };

  [selRound, selVP, selArea, selTopic, selFormat, selStatus].forEach(el=>{
  if (!el) return;
  el.onchange = ()=> { refreshDependentOptions(); renderAreaContainers(); };
});

}


function filteredItems(ignoreResult=false){
  const areaSel   = norm(document.getElementById('f_area').value);
  const vpSel     = norm(document.getElementById('f_vp').value);
  const topicSel  = norm(document.getElementById('f_topic').value);
  const formatSel = norm(document.getElementById('f_format').value);
const storeQ    = norm(document.getElementById('f_store')?.value);
  const statusSel = norm(document.getElementById('f_status')?.value); 
  return ALL_ITEMS.filter(it=>{
    const okA  = !areaSel   || norm(it.area)    === areaSel;
    const okV  = !vpSel     || norm(it.region)  === vpSel;
    const okT  = !topicSel  || norm(it.topic)   === topicSel;
    const okF  = !formatSel || norm(it.format)  === formatSel;
    const okS  = !storeQ    || norm(it.storeCode).includes(storeQ) || norm(it.storeName).includes(storeQ);
    const okR  = ignoreResult || !result || norm(it.answer).includes(result);
    const okAS = !statusSel  || norm(it.status || it.action?.status) === statusSel; 
    return okA && okV && okT && okF && okS && okR && okAS;
  });
}

function filteredPivotRows(){
  const roundSel  = qs('f_round').value;
  const vpSel     = norm(qs('f_vp').value);
  const areaSel   = norm(qs('f_area').value);
  const topicSel  = norm(qs('f_topic').value);
  const formatSel = norm(qs('f_format').value);
 const storeQ    = norm(qs('f_store').value);
  const statusSel = norm(qs('f_status').value); // ‚¨ÖÔ∏è ‡πÄ‡∏û‡∏¥‡πà‡∏°

  let rows = pivotByQuestionAcrossRounds(ALL_ITEMS);

  if (roundSel) rows = rows.filter(r =>
    [1,2,3].some(rd => String(r.roundRaw?.[rd]?.round ?? '') === String(roundSel))
  );
  if (vpSel)     rows = rows.filter(r => norm(r.roundRaw?.[1]?.region || r.roundRaw?.[2]?.region || r.roundRaw?.[3]?.region) === vpSel);
  if (areaSel)   rows = rows.filter(r => norm(r.area)   === areaSel);
  if (topicSel)  rows = rows.filter(r => norm(r.topic)  === topicSel);
  if (formatSel) rows = rows.filter(r =>
    [1,2,3].some(rd => norm(r.roundRaw?.[rd]?.format) === formatSel)
  );
  if (storeQ)    rows = rows.filter(r => norm(r.storeCode).includes(storeQ) || norm(r.storeName).includes(storeQ));
  
  // ‚¨ÖÔ∏è ‡∏Å‡∏£‡∏≠‡∏á‡∏ï‡∏≤‡∏° Status: ‡∏ñ‡πâ‡∏≤‡∏£‡∏≠‡∏ö‡πÉ‡∏î‡∏£‡∏≠‡∏ö‡∏´‡∏ô‡∏∂‡πà‡∏á‡∏°‡∏µ status ‡∏ï‡∏£‡∏á ‡∏´‡∏£‡∏∑‡∏≠‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏Ç‡∏≠‡∏á‡πÅ‡∏ñ‡∏ß‡∏ô‡∏±‡πâ‡∏ô‡∏ï‡∏£‡∏á
  if (statusSel) {
    rows = rows.filter(r => {
      const anyRoundMatch = [1,2,3].some(rd => norm(r.roundRaw?.[rd]?.action?.status) === statusSel);
      const latestMatch   = norm(r.action?.status) === statusSel;
      return anyRoundMatch || latestMatch;
    });
  }

  return rows;
}

function groupAreaTopicQuestion(rows){
  const g = new Map();
  for (const r of rows){
    if (!g.has(r.area)) g.set(r.area, new Map());
    const tmap = g.get(r.area);
    if (!tmap.has(r.topic)) tmap.set(r.topic, new Map());
    const qmap = tmap.get(r.topic);
    if (!qmap.has(r.question)) qmap.set(r.question, []);
    qmap.get(r.question).push(r);
  }
  return g;
}

const cmpTH = (a, b) => String(a ?? '').localeCompare(String(b ?? ''), 'th', { numeric: true, sensitivity: 'base' });

function buildRowAttach(host, images){
  if (!host) return;
  host.innerHTML = '';
  const wrap = document.createElement('div'); wrap.className='row-att';
  const grid = document.createElement('div'); grid.className='grid3'; wrap.appendChild(grid);
  const nav = document.createElement('div'); nav.className='nav';
  const btnPrev=document.createElement('button'); btnPrev.className='icon-btn';
  btnPrev.innerHTML=`<svg class="w-4 h-4" viewBox="0 0 24 24" fill="none"><path d="M15 19l-7-7 7-7" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/></svg>`;
  const pageLbl=document.createElement('span'); pageLbl.className='page';
  const btnNext=document.createElement('button'); btnNext.className='icon-btn';
  btnNext.innerHTML=`<svg class="w-4 h-4" viewBox="0 0 24 24" fill="none"><path d="M9 5l7 7-7 7" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/></svg>`;
  nav.append(btnPrev,pageLbl,btnNext);

  let page=0, size=3;
  function render(){
    grid.innerHTML=''; const totalPages=Math.max(1, Math.ceil(images.length/size));
    const start=page*size; const slice=images.slice(start,start+size);
    if(slice.length===0){ grid.innerHTML=`<div class="text-[10px] text-slate-400 col-span-3">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏π‡∏õ‡πÅ‡∏ô‡∏ö</div>`; nav.style.display='none'; }
    else{
      slice.forEach(src=>{
        const a=document.createElement('a'); a.href=src; a.target='_blank'; a.rel='noopener';
        const img=document.createElement('img'); img.alt='attach'; img.loading='lazy'; img.src=src;
        img.addEventListener('error', ()=>{ a.textContent='‡πÄ‡∏õ‡∏¥‡∏î‡∏•‡∏¥‡∏á‡∏Å‡πå'; a.className='text-[11px] underline text-slate-600 flex items-center justify-center h-16 border rounded'; });
        a.appendChild(img); grid.appendChild(a);
      });
      nav.style.display = images.length>size ? 'flex' : 'none';
    }
    pageLbl.textContent=`${Math.min(page+1,totalPages)}/${totalPages}`;
    btnPrev.disabled=page<=0; btnNext.disabled=page>=totalPages-1;
  }
  btnPrev.onclick=()=>{ if(page>0){ page--; render(); } };
  btnNext.onclick=()=>{ const totalPages=Math.ceil(images.length/size)||1; if(page<totalPages-1){ page++; render(); } };
  host.append(wrap,nav); render();
}

function renderAreaContainers(){
  const rows = filteredPivotRows();
  const groups = groupAreaTopicQuestion(rows);
  const host = qs('areaContainers'); host.innerHTML='';
  if(!rows.length){ host.innerHTML = `<div class="text-center text-slate-600 py-8">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏≤‡∏°‡∏ï‡∏±‡∏ß‡∏Å‡∏£‡∏≠‡∏á</div>`; return; }

  const areas = Array.from(groups.keys()).sort(cmpTH);
  for (const area of areas){
    const topicMap = groups.get(area);

    const areaCard = document.createElement('div');
    areaCard.className = 'rounded-2xl border bg-white/90 backdrop-blur shadow-sm';

    const head = document.createElement('div');
    head.className = 'px-4 py-3 border-b flex items-center justify-between';
    head.innerHTML = `
      <div class="flex items-center gap-3">
        <span class="inline-flex items-center justify-center w-8 h-8 rounded-xl bg-emerald-100 text-emerald-700 border border-emerald-200">A</span>
        <div>
          <div class="font-semibold text-slate-900">Area: ${area||'(‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà)'}</div>
          <div class="text-xs text-slate-500">Topic: ${topicMap.size}</div>
        </div>
      </div>`;
    areaCard.appendChild(head);

    const body = document.createElement('div');
    body.className = 'p-3 space-y-3';

    const topics = Array.from(topicMap.keys()).sort(cmpTH);
    for (const topic of topics){
      const qmap = topicMap.get(topic);
      const topicBox = document.createElement('div'); topicBox.className = 'rounded-xl border bg-white/70';topicBox.setAttribute('data-topic-box','');
topicBox.setAttribute('data-key', `${area}||${topic}`);
      const topicHead = document.createElement('button'); topicHead.type='button'; topicHead.className='w-full text-left px-3 py-2 border-b bg-slate-50/70 rounded-t-xl flex items-center justify-between';
      topicHead.innerHTML = `<span class="font-medium text-slate-800">Topic: ${topic||'-'}</span><span class="text-xs text-slate-500">‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡∏¥‡∏î/‡∏õ‡∏¥‡∏î</span>`;
      const topicBody = document.createElement('div'); topicBody.className = 'p-2 hidden';topicBody.setAttribute('data-topic-body','');
      topicHead.addEventListener('click', ()=> topicBody.classList.toggle('hidden'));

      const questions = Array.from(qmap.keys()).sort(cmpTH);
      for (const question of questions){
        const items = qmap.get(question).slice().sort((a,b)=>cmpTH(a.storeCode, b.storeCode));
        const box = document.createElement('div'); box.className='rounded-lg border bg-white mb-2';
        box.innerHTML = `
          <div class="px-3 py-2 border-b bg-white rounded-t-lg">
            <div class="text-[13px] text-slate-700"><span class="font-semibold">Question:</span> ${question||'-'}</div>
          </div>
          <div class="p-2">
            <table class="text-sm w-full">
              <thead class="bg-slate-50 text-slate-700">
                <tr>
                  <th class="px-2 py-2 text-left  w-[220px]">Store</th>
                  <th class="px-2 py-2 text-center w-[110px]">Round1</th>
                  <th class="px-2 py-2 text-center w-[110px]">Round2</th>
                  <th class="px-2 py-2 text-center w-[110px]">Round3</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>`;
        const tbody = box.querySelector('tbody');

        items.forEach(row=>{
          const tr = document.createElement('tr');
          const tone = anyYellowRed(row.roundAns);
          if (tone==='red') tr.classList.add('row-red'); else if (tone==='yellow') tr.classList.add('row-yellow');

          tr.innerHTML = `
            <td class="px-2 py-2 align-top">
              <div class="font-semibold">${row.storeCode||''}</div>
              <div class="text-[11px] text-slate-500">${row.storeName||''}</div>
              <div class="row-att mt-1" data-att></div>
            </td>
            ${[1,2,3].map(rn=>{
  const ans = row.roundAns[rn];
  const isYR = /yellow|red/i.test(String(ans||''));

  // ‡∏´‡∏≤ status ‡∏Ç‡∏≠‡∏á "‡∏£‡∏≠‡∏ö‡∏ó‡∏µ‡πà rn" ‡∏Å‡πà‡∏≠‡∏ô ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÉ‡∏ä‡πâ‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î
  const perRoundAct = row.roundRaw?.[rn]?.action || null;
  const actStatus   = (perRoundAct?.status || row.action?.status || '').trim().toLowerCase();
  const isDone      = (actStatus === 'done');

  const iconSvg = isDone
    ? `<svg class="w-4 h-4 text-emerald-600" viewBox="0 0 24 24" fill="none">
         <path d="M5 13l4 4L19 7" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"/>
       </svg>`
    : `<svg class="w-4 h-4" viewBox="0 0 24 24" fill="none">
         <path d="M12 5v14M5 12h14" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
       </svg>`;

  return `
    <td class="px-2 py-2 align-top text-center">
      <div class="flex items-center justify-center gap-2">
        ${pill(ans)}
        ${isYR ? `
          <button class="icon-btn" title="${isDone ? '‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô (Done)' : '‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏£‡∏≠‡∏ö '+rn}" data-plus
            data-refno="${row.roundRaw?.[rn]?.refno||''}"
            data-topic="${row.topic}"
            data-area="${row.area||''}"
            data-question="${row.question}"
            data-round="${rn}"
            data-store="${row.storeCode||''}"
            data-actionid="${row.actionId||''}"
            data-comment="${(row.roundRaw?.[rn]?.comment||'').replace(/"/g,'&quot;')}"
            data-reason="${(row.roundRaw?.[rn]?.reason||'').replace(/"/g,'&quot;')}"
            data-action="${(perRoundAct?.text || row.action?.text || '').replace(/"/g,'&quot;')}"
            data-status="${perRoundAct?.status || row.action?.status || ''}"
            data-due="${(perRoundAct?.dueDate || row.action?.dueDate || '').slice(0,10)}">
            ${iconSvg}
          </button>` : ``}
      </div>
    </td>`;
}).join('')}
`;

          const attHost = tr.querySelector('[data-att]');
         const imgs = [1,2,3]
  .flatMap(rn => (row.roundRaw?.[rn]?.attachments || []).map(a => a.url))
  .filter(Boolean);

  if (attHost) buildRowAttach(attHost, imgs);

          tr.querySelectorAll('[data-plus]').forEach(btn=>{
            btn.addEventListener('click', ()=>{
              openActionModal({
                refno: btn.getAttribute('data-refno'),
                actionId: btn.getAttribute('data-actionid')||'',
                area: btn.getAttribute('data-area')||'',
                topic: btn.getAttribute('data-topic')||'',
                question: btn.getAttribute('data-question')||'',
                round: Number(btn.getAttribute('data-round'))||'',
                storeCode: btn.getAttribute('data-store')||'', 
                comment: btn.getAttribute('data-comment')?.replace(/&quot;/g,'"')||'',
                reason: btn.getAttribute('data-reason')?.replace(/&quot;/g,'"')||'',
                currentAction: btn.getAttribute('data-action')?.replace(/&quot;/g,'"')||'',
                currentStatus: btn.getAttribute('data-status')||'Sent BU',
                currentDue: btn.getAttribute('data-due')||''
              });
            });
          });

          tbody.appendChild(tr);
        });

        topicBody.appendChild(box);
      }

      topicBox.append(topicHead, topicBody);
      body.appendChild(topicBox);
    }

    areaCard.appendChild(body);
    host.appendChild(areaCard);
  }
}

function getOpenTopicKeys(){
  // ‡πÄ‡∏Å‡πá‡∏ö key ‡πÄ‡∏õ‡πá‡∏ô "area||topic" ‡∏Ç‡∏≠‡∏á‡∏Å‡∏•‡πà‡∏≠‡∏á‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡∏¥‡∏î‡∏≠‡∏¢‡∏π‡πà
  const keys = new Set();
  document.querySelectorAll('[data-topic-box]').forEach(box=>{
    const body = box.querySelector('[data-topic-body]');
    if (body && !body.classList.contains('hidden')) {
      keys.add(box.getAttribute('data-key'));
    }
  });
  return keys;
}

function restoreOpenTopicKeys(openSet){
  // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏´‡∏•‡∏±‡∏á renderAreaContainers ‡πÄ‡∏™‡∏£‡πá‡∏à
  document.querySelectorAll('[data-topic-box]').forEach(box=>{
    const key = box.getAttribute('data-key');
    const body = box.querySelector('[data-topic-body]');
    if (!body) return;
    if (openSet.has(key)) body.classList.remove('hidden');
  });
}

async function searchWithRestore(){
  // ‡πÄ‡∏Å‡πá‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏õ‡∏¥‡∏î/‡∏õ‡∏¥‡∏î + scroll ‡∏Å‡πà‡∏≠‡∏ô‡πÇ‡∏´‡∏•‡∏î‡πÉ‡∏´‡∏°‡πà
  const openSet = getOpenTopicKeys();
  const prevScroll = window.scrollY;

  await search();        // ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• + render ‡πÉ‡∏´‡∏°‡πà (‡∏ï‡∏≤‡∏°‡πÄ‡∏î‡∏¥‡∏°‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì)

  // ‡∏Ñ‡∏∑‡∏ô‡∏Ñ‡πà‡∏≤‡πÄ‡∏õ‡∏¥‡∏î/‡∏õ‡∏¥‡∏î + ‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏™‡∏Å‡∏≠‡∏£‡πå‡∏•
  restoreOpenTopicKeys(openSet);
  window.scrollTo({ top: prevScroll, behavior: 'instant' });
}

/***************** Modal *****************/
function openActionModal(ctx){
  AM_CTX = ctx;
  const setMeta=(id,val)=>{ const el=qs(id); el.textContent=val||'-'; el.title=val||'-'; };
  setMeta('am_meta_area', ctx.area||'-');
  setMeta('am_meta_topic', ctx.topic||'-');
  setMeta('am_meta_question', ctx.question||'-');
  qs('am_round').textContent = ctx.round || '-';
  qs('am_comment_ro').textContent = ctx.comment || '‚Äî';
  qs('am_reason_ro').textContent  = ctx.reason  || '‚Äî';
  qs('am_action').value = ctx.currentAction || '';
  qs('am_status').value = ctx.currentStatus || 'Sent BU';
  qs('am_due').value    = (ctx.currentDue||'').slice(0,10);
  const m = qs('actionModal'); m.classList.add('show'); m.setAttribute('aria-hidden','false');
}
function closeActionModal(){ const m = qs('actionModal'); m.classList.remove('show'); m.setAttribute('aria-hidden','true'); AM_CTX=null; }
qs('am_close').onclick = ()=> closeActionModal();
qs('am_cancel').onclick = ()=> closeActionModal();
document.addEventListener('keydown', (e)=>{ if(e.key==='Escape') closeActionModal(); });
qs('actionModal').querySelector('.backdrop').onclick = ()=> closeActionModal();

qs('am_save').onclick = async ()=>{
  if(!AM_CTX) return;
  try{
    loading(true);

    // ‡∏´‡∏≤‡∏Å‡πÄ‡∏î‡∏¥‡∏°‡πÄ‡∏õ‡πá‡∏ô Sent BU ‡πÅ‡∏•‡∏∞‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏Å‡∏£‡∏≠‡∏Å ‡πÉ‡∏´‡πâ‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡πÄ‡∏õ‡πá‡∏ô In progress ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
    const prev = String(AM_CTX.currentStatus||'').trim().toLowerCase();
    const enteredText = (qs('am_action').value||'').trim();
    let statusVal = qs('am_status').value || AM_CTX.currentStatus || 'Sent BU';
    if(prev.startsWith('sent') && (enteredText || qs('am_due').value)) statusVal = 'In progress';

    const payload = {
      refno: AM_CTX.refno,
      action: { text: qs('am_action').value, dueDate: qs('am_due').value, status: statusVal }
    };
    if(AM_CTX.actionId) payload.actionId = AM_CTX.actionId;
    else payload.context = { topic: AM_CTX.topic, question: AM_CTX.question };

    await sbSaveAction(payload);

    // ‚úÖ ‡πÑ‡∏°‡πà‡∏õ‡∏¥‡∏î‡πÇ‡∏°‡∏î‡∏±‡∏• ‡πÉ‡∏´‡πâ‡∏Ñ‡πâ‡∏≤‡∏á‡πÑ‡∏ß‡πâ
    // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ñ‡πà‡∏≤‡πÉ‡∏ô‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏Ñ‡∏ß‡∏≤‡∏°‡∏à‡∏≥ (optimistic) ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡πÑ‡∏≠‡∏Ñ‡∏≠‡∏ô/‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
    try{
      const rows = pivotByQuestionAcrossRounds(ALL_ITEMS);
      // ‡∏´‡∏≤‡πÅ‡∏ñ‡∏ß‡∏ó‡∏µ‡πà‡∏™‡∏≠‡∏î‡∏Ñ‡∏•‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ö ctx ‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô
      const hit = rows.find(r =>
        String(r.refno)===String(AM_CTX.refno) &&
        String(r.topic)===String(AM_CTX.topic) &&
        String(r.question)===String(AM_CTX.question) &&
        String(r.roundRaw?.[AM_CTX.round]?.round||'')===String(AM_CTX.round)
      );
      if(hit){
        hit.action = hit.action || {};
        hit.action.text = qs('am_action').value;
        hit.action.status = statusVal;
        hit.action.dueDate = qs('am_due').value;
      }
    }catch(_){}

    // ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏à‡∏≠‡∏ô‡∏¥‡∏î‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡πÅ‡∏ö‡∏ö‡∏Ñ‡∏á‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏õ‡∏¥‡∏î/‡∏õ‡∏¥‡∏î + ‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏™‡∏Å‡∏≠‡∏£‡πå‡∏•
    await searchWithRestore();

    // ‡∏Ç‡∏∂‡πâ‡∏ô‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÄ‡∏ö‡∏≤ ‡πÜ ‡πÉ‡∏ô‡πÇ‡∏°‡∏î‡∏±‡∏• (‡πÑ‡∏°‡πà alert ‡πÄ‡∏î‡πâ‡∏á‡∏´‡∏ô‡πâ‡∏≤)
    qs('am_save').textContent = '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡πâ‡∏ß ‚úì';
    setTimeout(()=> qs('am_save').textContent = '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å', 1200);
  }catch(ex){ alert(ex.message||ex); }
  finally{ loading(false); }
};


/***************** Sidebar Toggle *****************/
const sidebar = qs('sidebar'); const overlay = qs('sbOverlay');
qs('btnHamburger')?.addEventListener('click', ()=>{
  closeActionModal();
  if(window.innerWidth <= 1024){ sidebar.classList.toggle('open'); overlay.classList.toggle('show'); }
  else{ sidebar.classList.toggle('closed'); }
});
overlay?.addEventListener('click', ()=>{ sidebar.classList.remove('open'); overlay.classList.remove('show'); });
</script>
</body>
</html>

